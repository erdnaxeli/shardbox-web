{% extends "layout.html.j2" %}
{% import "macros/date.j2" %}
{% import "macros/links.j2" %}

{% block page_title %}{{ shard.display_name }}@{{ release.version }} on Shardbox{% endblock %}

{% block main %}
  <header class="release-header">
    <h1 class="shard-title shard-name">
      {{ shard_name(shard) }}
    </h1>

    {% set description = shard.description | default(release.description) | default(repo.metadata.description) %}
    {% if description %}
      <div class="shard-description description">
        {{description | markdown}}
      </div>
    {% endif %}

    <div class="shard-info shard-info--release">
      <span class="datapoint datapoint--version">{{ release.version }}</span>
      <span class="datapoint datapoint--date">
        Released {{ release_date(release.released_at) }}
      </span>
      {% if release.latest %}
        <span class="datapoint datapoint--latest">Latest release</span>
      {% endif %}
      {% if release.yanked_at %}
        <span class="datapoint datapoint--yanked">Yanked release</span>
      {% endif %}
    </div>
  </header>

  {% if shard.archived %}
    <div class="shard-notice shard-notice__archived">
      <p class="large">Archived shard</p>
      <p>
        This shard has been archived {{ time_date(shard.archived_at)}}.
        It is no longer maintained or has been discontinued for other reasons.
      </p>
    </div>
  {% endif %}

  {% if repo.sync_failed_at %}
    <div class="shard-notice shard-notice__sync_failed_at">
      <p class="large">
        This repo seems to be no longer available at {{ repo_link(repo.ref) }}.
      </p>

      <p>
        Git synchronization failed {{ time_date(repo.sync_failed_at) }}.
        {% if repo.synced_at %}
          Last successful sync was {{ time_date(repo.synced_at) }}.
        {% else %}
          We could never reach it at the given location.
        {% endif %}
      </p>

      <a class="btn help-cta" href="/contribute">Help find it again!</a>
    </div>
  {% endif %}

  <div class="release-wrapper">
    <div class="release-main">
      {#<nav class="release-nav">
        <a href="{{ release_path(shard, release) }" class="active">Main</a>
        <a href="{{ release_path(shard, release) }/readme">README</a>
        <a href="{{ release_path(shard, release) }/shard.yml">shard.yml</a>
        <a href="{{ release_path(shard, release) }/dependents">dependents</a>
      </nav>#}

      <p>You can add this shard as a dependency by adding the following lines
        to the <code>dependencies</code> section in your <code>shard.yml</code>:</p>
      <div class="shards-spec">{{ shard.name }}:
    {{ repo.ref.resolver }}: {{ repo.ref.url }}
    version: ~> {{ release.version }}</div>

    <div class="container">
      <h3>Dependencies <span class="count">{{ dependencies | length }}</span></h3>
      <ul class="dependencies dependencies--runtime">
      {% for dep in dependencies %}
        <li>
          <a href="{{ shard_path(dep.shard) }}" class="dependency-name">{{ dep.shard.display_name }}</a>
          {% if dep.dependency.version_reference %}
            <span class="dependency-version" title="{{ dep.dependency.version_reference[0] }}: {{ dep.dependency.version_reference[1] }}">
              {{ dep.dependency.version_reference[1] }}
            </span>
          {% endif %}

          {% if dep.shard.description %}
            <span class="shard-description">{{ dep.shard.description }}</span>
          {% endif %}

          <pre>{{ dep.dependency.spec }}</pre>
        </li>
      {% endfor %}
      </ul>

      <h3>Development Dependencies <span class="count">{{ dev_dependencies | length }}</span></h3>
      <ul class="dependencies dependencies--development">
      {% for dep in dev_dependencies %}
        <li>
          {% if dep.shard %}
            <a href="{{ shard_path(dep.shard) }}" class="dependency-name">{{ dep.shard.display_name }}</a>
          {% else %}
            <span  class="dependency-name">{{ dep.dependency.name }}</span>
          {% endif %}
          {% if dep.dependency.version_reference %}
            <span class="dependency-version" title="{{ dep.dependency.version_reference[0] }}: {{ dep.dependency.version_reference[1] }}">
              {{ dep.dependency.version_reference[1] }}
            </span>
          {% endif %}

          {% if not dep.shard %}
            {% set repo_ref = dep.dependency.repo_ref %}
            {% if repo_ref %}
              <span class="dependency-reference">{{ repo_ref.resolver }}: {{ repo_ref.url }}</span>
            {% endif %}
          {% endif %}

          {% if dep.shard.description %}
            <span class="shard-description">{{ dep.shard.description }}</span>
          {% endif %}

          <pre>{{ dep.dependency.spec }}</pre>
        </li>
      {% endfor %}
      </ul>

      {% set libraries = release.spec["libraries"] %}
      {% if libraries %}
      <div class="shard-libraries">
        <h3>Libraries <span class="count">{{ libraries | count }}</span></h3>
        <ul>
          {% for name, version in libraries %}
            <li><code>{{ name }}</code>: <code>{{ version }}</code></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    <div class="container">
      <h3>Dependents <span class="count">{{ dependents | length }}</span></h3>
      <ul class="dependencies dependencies--dependents">
      {% for item in dependents %}
        <li>
          <a href="{{ shard_path(item.shard) }}" class="dependency-name"{% if item.shard.description %} title="{{ item.shard.description }}"{% endif %}>{{ item.shard.display_name }}</a>
          {% if item.dependents_count > 0 %}
          ({{item.dependents_count}} dependents)
          {% endif %}
        </li>
      {% endfor %}
      </ul>

      {% if mirrors | length > 0 %}
      <h3>Mirrors</h3>
      <ul>
      {% for mirror in mirrors %}
        <li>({{mirror.role}})  {{ repo_link(mirror.ref) }}</li>
      {% endfor %}
      </ul>
      {% endif %}

      {% if homonymous_shards | length > 0 %}
      <h3>Similar shards</h3>
      <ul>
      {% for item in homonymous_shards %}
        <li>
          <a href="/shards/{{ item.slug }}" class="shard-name">{{ item.display_name}}</a>
        </li>
      {% endfor %}
      </ul>
      {% endif %}
    </div>
    </div>

    <div class="release-sidebar">
    {% include "releases/_infobox.html.j2" %}

      <div class="grouping">
        <h3>Releases</h3>
        <ul class="list-releases">
        {% set current_version = release.version %}
        {% for release in releases %}
          <li{% if release.version == current_version %} class="current"{% endif %}>
            <a href="/shards/{{shard.slug}}/{{release.version}}">
              <span class="release-version">{{ release.version }}</span>
              <span class="release-date">{{ release.released_at | date('%Y-%m-%d') }}</span>
              <span class="release-span">{{ release_date(release.released_at) }}</span>
            </a>
          </li>
        {% endfor %}
        </ul>
      </div>

      <div class="grouping">
        Last synced {{ time_date(repo.synced_at) }}.
      </div>
    </div>
  </div>

  {% if categories %}
    <div class="category-edit">
      {% set category = categories[0] %}
      <a href="https://github.com/shardbox/catalog/edit/master/catalog/{{ category.slug }}.yml" class="btn edit"
        title="You can edit the category including this shard on GitHub">
        {{ icon("edit") }} Edit in category {{ category.name }}
      </a>
      <a href="/contribute" class="help">?</a>
    </div>
  {% endif %}
{% endblock %}
